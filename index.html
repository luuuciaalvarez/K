<script>
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = SpeechRecognition ? new SpeechRecognition() : null;
  let micActivo = false;

  document.addEventListener('DOMContentLoaded', () => {
    if (recognition) {
      recognition.continuous = true;
      recognition.interimResults = false;
      recognition.lang = "es-ES";

      recognition.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript;
        const input = document.getElementById("textInput");

        input.value = input.value.trim() ? input.value + " " + transcript : transcript;
        console.log("🎙 Texto añadido:", transcript);
      };

      recognition.onerror = (event) => {
        console.error("⚠️ Error de reconocimiento:", event.error);
        micActivo = false;
        alert("Hubo un problema con el micrófono: " + event.error);
      };

    } else {
      alert("⚠️ Este navegador no soporta reconocimiento de voz.");
    }
  });

  function startRecognition() {
    if (!recognition) {
      alert("⚠️ El reconocimiento de voz no está disponible.");
      return;
    }

    if (!micActivo) {
      recognition.start();
      micActivo = true;
      console.log("🎤 Micrófono activado y escuchando...");
    }
  }

  async function sendMessage() {
    if (!document.getElementById("textInput").value.trim()) return;

    if (recognition && micActivo) {
      recognition.stop();
      console.log("🎤 Micrófono detenido al enviar");
    }

    document.getElementById("loadingDots").style.display = "flex";
    document.getElementById("responseText").innerText = "";

    try {
      const response = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: document.getElementById("textInput").value.trim() })
      });

      const data = await response.json();
      const respuestaTexto = typeof data.response === "object"
        ? data.response.message || data.response.content || JSON.stringify(data.response, null, 2)
        : data.response || "No se recibió una respuesta válida.";

      displayResponse(respuestaTexto);
    } catch (error) {
      console.error("❌ Error en la API:", error);
      document.getElementById("responseText").innerText = "No se pudo conectar con la IA.";
      micActivo = false;
    } finally {
      document.getElementById("loadingDots").style.display = "none";
    }
  }

  function displayResponse(response) {
    document.getElementById("responseText").innerText = "Respuesta: " + response;

    if (micActivo && 'speechSynthesis' in window) {
      const synth = window.speechSynthesis;
      const utterance = new SpeechSynthesisUtterance(response);
      utterance.lang = "es-ES";

      utterance.onend = () => {
        console.log("🔁 Vuelve a escuchar tras hablar.");
        recognition.start(); // reinicia la escucha
      };

      synth.speak(utterance);
    }
  }
</script>

    

   
      
